<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyPlanner</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0d6efd" />
    <link rel="icon" href="icons/icon-512.png" type="image/ico" />

    <script>
      /* Prevent auto-scroll on reload */
      if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual";
      }
      window.addEventListener("beforeunload", () => window.scrollTo(0, 0));
      window.addEventListener("load", () =>
        setTimeout(() => window.scrollTo(0, 0), 0)
      );
    </script>
  </head>

  <body>
    <div class="login-overlay" id="loginOverlay">
      <div class="login-box">
        <h1>MyPlanner</h1>
        <h3>Enter your login credentials</h3>

        <form id="loginForm">
          <div class="login-row">
            <div class="form-row">
              <label for="first">Username:</label>
              <input type="text" id="first" name="first" required />
            </div>

            <div class="form-row">
              <label for="password">Password:</label>
              <input type="password" id="password" name="password" required />
            </div>
          </div>

          <div class="wrap">
            <button type="submit">Log In</button>
          </div>
        </form>

        <div class="option">
          <p>
            Not registered?
            <a href="#" id="openSignup">Create a new account</a>
          </p>

          <button id="guestBtn" class="guest-btn">Continue as Guest</button>
        </div>
      </div>
    </div>

    <div class="signup-overlay" id="signupOverlay">
      <div class="signup-box">
        <h1>MyPlanner</h1>
        <h3>Create a new account</h3>

        <form id="signupForm">
          <div class="signup-row">
            <div class="form-row">
              <label for="first">Username:</label>
              <input type="text" id="first" name="first" required />
            </div>

            <div class="form-row">
              <label for="password">Password:</label>
              <input type="password" id="password" name="password" required />
            </div>

            <div class="form-row">
              <label for="repeatpassword">Repeat Password:</label>
              <input
                type="password"
                id="repeatpassword"
                name="repeatpassword"
                required
              />
            </div>
          </div>

          <div class="wrap">
            <button type="submit">Create Account</button>
          </div>
        </form>

        <div class="option">
          <p>
            Already got an account
            <a href="#" id="openLogin">Log In</a>
          </p>

          <button id="guestBtn" class="guest-btn">Continue as Guest</button>
        </div>
      </div>
    </div>

    <div class="main-wrapper">
      <header>
        <h1>MyPlanner</h1>
        <section class="progress">
          <div class="progress-bar">
            <div id="progressFill"></div>
          </div>
        </section>
        <div style="display: flex; align-items: center; gap: 10px">
          <button id="loginBtn" class="general-btn" style="display: none">
            Login
          </button>
          <button id="logoutBtn" class="general-btn" style="display: none">
            Logout
          </button>
          <label class="theme-switch">
            <input type="checkbox" id="theme-toggle" />
            <span class="slider"></span>
          </label>
        </div>
      </header>

      <main class="main-content">
        <div id="introWrapper">
          <section class="intro-area">
            <h1>Stay organised, Stay productive</h1>
            <p>Track your tasks and goals all in one place.</p>
          </section>
        </div>

        <div id="introSentinel"></div>

        <section class="input-area">
          <input type="text" id="taskInput" placeholder="Add a new task..." />

          <div class="dropdown">
            <button id="dropdownToggle" class="general-btn">
              Choose Category
              <span id="chooseCatArrow"
                ><img src="img/dropdown-arrow.svg"
              /></span>
            </button>
            <div id="dropdownMenu" class="dropdown-menu"></div>
          </div>

          <div class="calendar-wrap">
            <button id="calendarBtn" class="calendar-btn">
              <img src="img/icons8-calendar-24.png" />
            </button>
            <input type="date" id="dateAdd" />
          </div>

          <button id="addTask" class="general-btn">Add</button>

          <button id="askAIToggle" class="general-btn">
            Search
            <span id="askAIArrow"><img src="img/dropdown-arrow.svg" /></span>
          </button>
        </section>

        <div class="ai-dropdown" id="aiDropdown">
          <input
            type="text"
            id="AIInput"
            placeholder="What do you want to search for?"
          />
          <button id="askAISubmit" class="general-btn">Search</button>
        </div>

        <section class="ai-response">
          <h3>AI Response:</h3>
          <p id="AIOutput">Your AI results will appear here...</p>
        </section>

        <section class="task-list">
          <h2>Your Tasks</h2>
          <section class="task-filters tab-group">
            <span class="tab-indicator"></span>
          </section>
          <ul id="tasks"></ul>
        </section>
      </main>

      <footer class="site-footer"></footer>
    </div>

    <script src="script.js"></script>

    <script>
      const loginOverlay = document.getElementById("loginOverlay");
      const signupOverlay = document.getElementById("signupOverlay");

      const openSignup = document.getElementById("openSignup");
      const openLogin = document.getElementById("openLogin");

      const loginForm = document.getElementById("loginForm");
      const signupForm = document.getElementById("signupForm");
      const guestBtns = document.querySelectorAll(".guest-btn");

      // Show signup overlay
      openSignup.addEventListener("click", (e) => {
        e.preventDefault();
        loginOverlay.style.display = "none";
        signupOverlay.style.display = "flex";
      });

      // Return to login overlay
      openLogin.addEventListener("click", (e) => {
        e.preventDefault();
        signupOverlay.style.display = "none";
        loginOverlay.style.display = "flex";
      });

      // Close overlays and set current user
      function closeOverlay(username) {
        localStorage.setItem("currentUser", username);
        document.body.classList.remove("overlay-active");
        loginOverlay.style.display = "none";
        signupOverlay.style.display = "none";

        const logoutBtn = document.getElementById("logoutBtn");
        const loginBtn = document.getElementById("loginBtn");
        if (username !== "guest") {
          logoutBtn.style.display = "block";
          loginBtn.style.display = "none";
        } else {
          logoutBtn.style.display = "none";
          loginBtn.style.display = "block";
        }

        // Trigger a custom event to reload tasks for the logged-in user
        window.dispatchEvent(new Event("userLoggedIn"));
      }

      // Get all registered users
      function getUsers() {
        return JSON.parse(localStorage.getItem("users")) || {};
      }

      // Save users data
      function saveUsers(users) {
        localStorage.setItem("users", JSON.stringify(users));
      }

      // Handle login
      loginForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const username = document
          .querySelector('#loginForm input[name="first"]')
          .value.trim();
        const password = document.querySelector(
          '#loginForm input[name="password"]'
        ).value;

        const users = getUsers();

        if (users[username] && users[username].password === password) {
          closeOverlay(username);
        } else {
          alert("Invalid username or password");
        }
      });

      // Handle signup
      signupForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const username = document
          .querySelector('#signupForm input[name="first"]')
          .value.trim();
        const password = document.querySelector(
          '#signupForm input[name="password"]'
        ).value;
        const repeatPassword = document.querySelector(
          '#signupForm input[name="repeatpassword"]'
        ).value;

        if (password !== repeatPassword) {
          alert("Passwords do not match");
          return;
        }

        const users = getUsers();

        if (users[username]) {
          alert("Username already exists");
          return;
        }

        // Create new user with empty task list
        users[username] = {
          password: password,
          tasks: [],
          categories: ["all", "work", "school", "planner", "personal"],
        };

        saveUsers(users);
        alert("Account created successfully!");

        // Switch to login
        signupOverlay.style.display = "none";
        loginOverlay.style.display = "flex";
      });

      // Handle guest login
      guestBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          closeOverlay("guest");
        });
      });

      // Activate blur on load
      document.body.classList.add("overlay-active");

      // Check if user is already logged in
      const currentUser = localStorage.getItem("currentUser");
      if (currentUser) {
        document.body.classList.remove("overlay-active");
        loginOverlay.style.display = "none";
        signupOverlay.style.display = "none";

        const logoutBtn = document.getElementById("logoutBtn");
        const loginBtn = document.getElementById("loginBtn");
        if (currentUser !== "guest") {
          logoutBtn.style.display = "block";
          loginBtn.style.display = "none";
        } else {
          logoutBtn.style.display = "none";
          loginBtn.style.display = "block";
        }
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("currentUser");
        location.reload();
      });

      // Handle login button (for guests)
      document.getElementById("loginBtn").addEventListener("click", () => {
        localStorage.removeItem("currentUser");
        location.reload();
      });
    </script>
  </body>
</html>
