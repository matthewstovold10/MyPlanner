<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyPlanner</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0d6efd" />
    <link rel="icon" href="icons/icon-512.png" type="image/ico" />

    <script>
      /* Prevent auto-scroll on reload */
      if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual";
      }
      window.addEventListener("beforeunload", () => window.scrollTo(0, 0));
      window.addEventListener("load", () =>
        setTimeout(() => window.scrollTo(0, 0), 0)
      );
    </script>
  </head>

  <body>
    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
      <div class="login-box">
        <h1>MyPlanner</h1>
        <h3>Enter your login credentials</h3>

        <form id="loginForm">
          <div class="login-row">
            <div class="form-row">
              <label for="loginUsername">Username:</label>
              <input type="text" id="loginUsername" required />
            </div>
            <div class="form-row">
              <label for="loginPassword">Password:</label>
              <input type="password" id="loginPassword" required />
            </div>
          </div>
          <div class="wrap">
            <button type="submit">Log In</button>
          </div>
        </form>

        <div class="option">
          <p>
            Not registered? <a href="#" id="openSignup">Create a new account</a>
          </p>
          <button id="guestLogin" class="guest-btn">Continue as Guest</button>
        </div>
      </div>
    </div>

    <!-- Signup Overlay -->
    <div class="signup-overlay" id="signupOverlay">
      <div class="signup-box">
        <h1>MyPlanner</h1>
        <h3>Create a new account</h3>

        <form id="signupForm">
          <div class="signup-row">
            <div class="form-row">
              <label for="signupUsername">Username:</label>
              <input type="text" id="signupUsername" required />
            </div>
            <div class="form-row">
              <label for="signupPassword">Password:</label>
              <input type="password" id="signupPassword" required />
            </div>
            <div class="form-row">
              <label for="signupRepeatPassword">Repeat Password:</label>
              <input type="password" id="signupRepeatPassword" required />
            </div>
          </div>
          <div class="wrap">
            <button type="submit">Create Account</button>
          </div>
        </form>

        <div class="option">
          <p>Already have an account? <a href="#" id="openLogin">Log In</a></p>
          <button id="guestSignup" class="guest-btn">Continue as Guest</button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-wrapper">
      <header>
        <h1>MyPlanner</h1>
        <section class="progress">
          <div class="progress-bar">
            <div id="progressFill"></div>
          </div>
        </section>
        <div style="display: flex; align-items: center; gap: 10px">
          <div style="display: flex; align-items: center">
            <span id="currentUserDisplay"></span>
            <button id="loginBtn" class="general-btn" style="display: none">
              Login
            </button>
            <button id="logoutBtn" class="general-btn" style="display: none">
              Logout
            </button>
          </div>
          <label class="theme-switch">
            <input type="checkbox" id="theme-toggle" />
            <span class="slider"></span>
          </label>
        </div>
      </header>

      <main class="main-content">
        <div id="introWrapper">
          <section class="intro-area">
            <h1>Stay organised, Stay productive</h1>
            <p>Track your tasks and goals all in one place.</p>
          </section>
        </div>

        <div id="introSentinel"></div>

        <section class="input-area">
          <input type="text" id="taskInput" placeholder="Add a new task..." />

          <div class="dropdown">
            <button id="dropdownToggle" class="general-btn">
              Choose Category
              <span id="chooseCatArrow"
                ><img src="img/dropdown-arrow.svg"
              /></span>
            </button>
            <div id="dropdownMenu" class="dropdown-menu"></div>
          </div>

          <div class="calendar-wrap">
            <button id="calendarBtn" class="calendar-btn">
              <img src="img/icons8-calendar-24.png" />
            </button>
            <input type="date" id="dateAdd" />
          </div>

          <button id="addTask" class="general-btn">Add</button>

          <button id="askAIToggle" class="general-btn">
            Search
            <span id="askAIArrow"><img src="img/dropdown-arrow.svg" /></span>
          </button>
        </section>

        <div class="ai-dropdown" id="aiDropdown">
          <input
            type="text"
            id="AIInput"
            placeholder="What do you want to search for?"
          />
          <button id="askAISubmit" class="general-btn">Search</button>
        </div>

        <section class="ai-response">
          <h3>AI Response:</h3>
          <p id="AIOutput">Your AI results will appear here...</p>
        </section>

        <section class="task-list">
          <h2>Your Tasks</h2>
          <section class="task-filters tab-group">
            <span class="tab-indicator"></span>
          </section>
          <ul id="tasks"></ul>
        </section>
      </main>

      <footer class="site-footer"></footer>
    </div>

    <script src="script.js"></script>

    <script>
      // Simple local authentication with usernames - no external dependencies!
      function initializeAuth() {
        console.log("Initializing local authentication...");

        // --- Elements ---
        const loginOverlay = document.getElementById("loginOverlay");
        const signupOverlay = document.getElementById("signupOverlay");
        const openSignup = document.getElementById("openSignup");
        const openLogin = document.getElementById("openLogin");
        const loginForm = document.getElementById("loginForm");
        const signupForm = document.getElementById("signupForm");
        const logoutBtn = document.getElementById("logoutBtn");
        const loginBtn = document.getElementById("loginBtn");
        const currentUserDisplay =
          document.getElementById("currentUserDisplay");
        const guestLoginBtn = document.getElementById("guestLogin");
        const guestSignupBtn = document.getElementById("guestSignup");

        console.log("Auth elements loaded successfully");

        // --- Overlay toggle ---
        openSignup.addEventListener("click", (e) => {
          e.preventDefault();
          loginOverlay.style.display = "none";
          signupOverlay.style.display = "flex";
        });

        openLogin.addEventListener("click", (e) => {
          e.preventDefault();
          signupOverlay.style.display = "none";
          loginOverlay.style.display = "flex";
        });

        // --- Close overlay and set user ---
        function closeOverlay(user) {
          console.log("closeOverlay called with user:", user);
          localStorage.setItem("currentUser", user);
          document.body.classList.remove("overlay-active");
          loginOverlay.style.display = "none";
          signupOverlay.style.display = "none";

          // Create user data structure if it doesn't exist
          if (user !== "guest") {
            const users = JSON.parse(localStorage.getItem("users")) || {};
            if (!users[user]) {
              users[user] = {
                categories: ["all", "work", "school", "planner", "personal"],
                tasks: [],
              };
              localStorage.setItem("users", JSON.stringify(users));
            }

            logoutBtn.style.display = "block";
            loginBtn.style.display = "none";
            currentUserDisplay.textContent = `Hello, ${user}`;
          } else {
            logoutBtn.style.display = "none";
            loginBtn.style.display = "block";
            currentUserDisplay.textContent = "Guest";
          }

          window.dispatchEvent(new Event("userLoggedIn"));
          console.log("User logged in successfully");
        }

        // Simple hash function for passwords (basic security)
        async function hashPassword(password) {
          const encoder = new TextEncoder();
          const data = encoder.encode(password);
          const hash = await crypto.subtle.digest("SHA-256", data);
          return Array.from(new Uint8Array(hash))
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");
        }

        // --- Signup ---
        signupForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const button = signupForm.querySelector("button[type='submit']");
          button.disabled = true;

          const username = document
            .getElementById("signupUsername")
            .value.trim();
          const password = document.getElementById("signupPassword").value;
          const repeat = document.getElementById("signupRepeatPassword").value;

          if (password !== repeat) {
            alert("Passwords do not match");
            button.disabled = false;
            return;
          }

          if (password.length < 6) {
            alert("Password must be at least 6 characters");
            button.disabled = false;
            return;
          }

          if (username.length < 3) {
            alert("Username must be at least 3 characters");
            button.disabled = false;
            return;
          }

          // Check if user already exists
          const accounts = JSON.parse(localStorage.getItem("accounts")) || {};
          if (accounts[username.toLowerCase()]) {
            alert("This username is already taken");
            button.disabled = false;
            return;
          }

          // Create account
          const hashedPassword = await hashPassword(password);
          accounts[username.toLowerCase()] = {
            password: hashedPassword,
            displayName: username,
            createdAt: new Date().toISOString(),
          };
          localStorage.setItem("accounts", JSON.stringify(accounts));

          alert("Account created successfully! You can now log in.");
          signupOverlay.style.display = "none";
          loginOverlay.style.display = "flex";

          button.disabled = false;
        });

        // --- Login ---
        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document
            .getElementById("loginUsername")
            .value.trim();
          const password = document.getElementById("loginPassword").value;

          const accounts = JSON.parse(localStorage.getItem("accounts")) || {};

          if (!accounts[username.toLowerCase()]) {
            alert("Invalid username or password");
            return;
          }

          const hashedPassword = await hashPassword(password);

          if (accounts[username.toLowerCase()].password !== hashedPassword) {
            alert("Invalid username or password");
            return;
          }

          closeOverlay(username);
        });

        // --- Guest login ---
        console.log("Setting up guest button listeners");
        guestLoginBtn.addEventListener("click", () => {
          console.log("Guest login button clicked");
          closeOverlay("guest");
        });
        guestSignupBtn.addEventListener("click", () => {
          console.log("Guest signup button clicked");
          closeOverlay("guest");
        });

        // --- Logout / Login button ---
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("currentUser");
          location.reload();
        });

        loginBtn.addEventListener("click", () => {
          localStorage.removeItem("currentUser");
          location.reload();
        });

        // --- Activate overlay on load ---
        document.body.classList.add("overlay-active");

        // --- Check if user already logged in ---
        const currentUser = localStorage.getItem("currentUser");
        if (currentUser) closeOverlay(currentUser);
      }

      // Start initialization
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeAuth);
      } else {
        initializeAuth();
      }
    </script>
  </body>
</html>
